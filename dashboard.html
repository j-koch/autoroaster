<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoRoaster - Dashboard</title>
    <link rel="stylesheet" href="./src/styles/dashboard.css">
    
    <!-- ONNX Runtime Web (for testbed simulator) -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script>
    
    <!-- Plotly.js for visualization (for testbed charts) -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-brand">â˜• AutoRoaster</div>
        <div class="navbar-user">
            <span class="user-email" id="user-email">Loading...</span>
            <button class="btn-signout" id="signout-btn">Sign Out</button>
        </div>
    </nav>
    
    <!-- Main Layout with Sidebar -->
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="#data-manager" class="sidebar-link active" data-page="data-manager">
                    <span class="sidebar-icon">ðŸ“Š</span>
                    <span class="sidebar-text">Data Manager</span>
                </a>
                <a href="./training.html" class="sidebar-link" data-page="training">
                    <span class="sidebar-icon">ðŸ¤–</span>
                    <span class="sidebar-text">Model Training</span>
                </a>
                <a href="#testbed" class="sidebar-link" data-page="testbed">
                    <span class="sidebar-icon">ðŸ§ª</span>
                    <span class="sidebar-text">Digital Testbed</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content Area -->
        <div class="container">
        <!-- Message Display -->
        <div id="message" class="message"></div>
        
        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" data-view="history">Roast History</button>
            <button class="view-tab" data-view="upload">Upload Roast</button>
        </div>
        
        <!-- Roast History View -->
        <div id="history-view" class="view active">
            <div class="roast-history-container">
                <!-- Left Column: Table -->
                <div class="table-column">
                    <div class="roast-history">
                        <h2>Your Roast History</h2>
                        
                        <!-- Filter and Sort Controls -->
                        <div id="filter-controls" class="filter-controls" style="display: none;">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="filter-origin">Origin</label>
                                    <input type="text" id="filter-origin" placeholder="Filter by origin...">
                                </div>
                                <div class="filter-group">
                                    <label for="filter-variety">Variety</label>
                                    <input type="text" id="filter-variety" placeholder="Filter by variety...">
                                </div>
                                <div class="filter-group">
                                    <label for="filter-roaster">Roaster</label>
                                    <input type="text" id="filter-roaster" placeholder="Filter by roaster...">
                                </div>
                                <div class="filter-group">
                                    <label for="filter-process">Process</label>
                                    <select id="filter-process">
                                        <option value="">All processes</option>
                                        <option value="washed">Washed</option>
                                        <option value="natural">Natural</option>
                                        <option value="honey">Honey</option>
                                        <option value="semi-washed">Semi-Washed</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="sort-by">Sort by</label>
                                    <select id="sort-by">
                                        <option value="upload_date_desc">Upload Date (Newest)</option>
                                        <option value="upload_date_asc">Upload Date (Oldest)</option>
                                        <option value="roast_date_desc">Roast Date (Newest)</option>
                                        <option value="roast_date_asc">Roast Date (Oldest)</option>
                                        <option value="origin_asc">Origin (A-Z)</option>
                                        <option value="origin_desc">Origin (Z-A)</option>
                                        <option value="charge_asc">Charge Mass (Low to High)</option>
                                        <option value="charge_desc">Charge Mass (High to Low)</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <button id="clear-filters" class="btn-clear">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                
                        <!-- Loading State -->
                        <div id="history-loading" class="loading">
                            <div class="loading-spinner"></div>
                            <div>Loading your roasts...</div>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="history-empty" class="empty-state" style="display: none;">
                            <div class="empty-state-icon">â˜•</div>
                            <h3>No Roasts Yet</h3>
                            <p>Upload your first roast to get started!</p>
                        </div>
                        
                        <!-- Visualize Selected Button -->
                        <div class="visualize-actions" id="visualize-actions" style="display: none;">
                            <button id="visualize-selected" class="btn-visualize-selected" title="Visualize selected roasts">
                                ðŸ“Š Visualize Selected (<span id="selection-count">0</span>)
                            </button>
                        </div>
                        
                        <!-- Table Container -->
                        <div id="history-table-container" class="table-container" style="display: none;">
                            <table class="roast-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all" title="Select all"></th>
                                        <th>Date</th>
                                        <th>Roaster</th>
                                        <th>Origin</th>
                                        <th>Variety</th>
                                        <th>Process</th>
                                        <th>Charge</th>
                                        <th>Final</th>
                                        <th>Uploaded</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="roast-table-body">
                                    <!-- Roasts will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Visualization -->
                <div class="viz-column">
                    <div class="viz-panel">
                        <h3 id="viz-panel-title">Select a roast to visualize</h3>
                        
                        <!-- Chart Loading -->
                        <div id="viz-panel-loading" class="loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <div>Loading roast data...</div>
                        </div>
                        
                        <!-- Charts Container -->
                        <div id="viz-panel-charts" style="display: none;">
                            <div id="temp-chart" class="chart-panel"></div>
                            <div id="control-chart" class="chart-panel"></div>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="viz-panel-empty" class="viz-empty-state">
                            <div class="viz-empty-icon">ðŸ“Š</div>
                            <p>Select roasts to visualize</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Digital Testbed View -->
        <div id="testbed-view" class="view">
            <div class="testbed-container">
                <!-- Left Column: Model Selection -->
                <div class="testbed-sidebar">
                    <h2>Model Selection</h2>
                    
                    <!-- Loading State -->
                    <div id="testbed-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <div>Loading ONNX models...</div>
                    </div>
                    
                    <!-- Error Display -->
                    <div id="testbed-error" class="error" style="display: none;"></div>
                    
                    <!-- Model Selection Form -->
                    <div id="testbed-controls" style="display: none;">
                        <!-- Roaster Model Selection -->
                        <div class="model-section">
                            <h3>Roaster Model <span class="required">*</span></h3>
                            <p class="section-hint">Select the roaster physics model</p>
                            <div class="form-group">
                                <select id="testbed-roaster-model" class="model-select">
                                    <option value="roast_stepper.onnx">Kaleido M1</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bean Model Selection -->
                        <div class="model-section">
                            <h3>Bean Model <span class="required">*</span></h3>
                            <p class="section-hint">Select the bean thermal model</p>
                            <div class="form-group">
                                <select id="testbed-bean-model" class="model-select">
                                    <option value="bean_guji.onnx">Guji</option>
                                    <option value="bean_hambela_buliye.onnx">Hambela Buliye</option>
                                    <option value="bean_sakaro.onnx">Sakaro</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Controller Model Selection -->
                        <div class="model-section">
                            <h3>Controller <span class="optional">(optional)</span></h3>
                            <p class="section-hint">Select AI controller or manual control</p>
                            <div class="form-group">
                                <select id="testbed-controller-model" class="model-select">
                                    <option value="manual">Manual Control</option>
                                    <option value="pid">PID Controller</option>
                                    <option value="control_policy.onnx">AutoRoaster AI</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="testbed-actions">
                            <button id="testbed-load-btn" class="btn-primary">
                                Load Models
                            </button>
                            <button id="testbed-reset-btn" class="btn-secondary" style="display: none;">
                                Reset Simulation
                            </button>
                        </div>
                        
                        <!-- Status Info -->
                        <div id="testbed-status" class="testbed-status" style="display: none;">
                            <div class="status-badge status-ready">
                                <span class="status-icon">âœ“</span>
                                <span>Models Loaded</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Simulator Interface -->
                <div class="testbed-main">
                    <div id="testbed-simulator" style="display: none;">
                        <!-- Roast Phase Indicator -->
                        <div id="testbed-phase" class="roast-phase phase-charging">
                            IDLE - Roaster Preheated to 180Â°C
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="button-group">
                            <button id="testbed-charge-btn" class="btn-success">Add Beans</button>
                            <button id="testbed-drop-btn" class="btn-danger" disabled>Stop</button>
                        </div>
                        
                        <!-- Control Section -->
                        <div class="controls-section">
                            <h3>Controls</h3>
                            
                            <div class="control-group">
                                <label for="testbed-heater-slider">Heater Power</label>
                                <div class="slider-container">
                                    <input type="range" id="testbed-heater-slider" class="slider" min="0" max="1" step="0.01" value="0.5">
                                    <span id="testbed-heater-value" class="value-display">50%</span>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label for="testbed-fan-slider">Fan Speed</label>
                                <div class="slider-container">
                                    <input type="range" id="testbed-fan-slider" class="slider" min="0" max="1" step="0.01" value="0.5">
                                    <span id="testbed-fan-value" class="value-display">50%</span>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label for="testbed-mass-slider">Bean Mass (g)</label>
                                <div class="slider-container">
                                    <input type="range" id="testbed-mass-slider" class="slider" min="50" max="200" step="5" value="150">
                                    <span id="testbed-mass-value" class="value-display">150g</span>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label for="testbed-ambient-slider">Ambient Temperature (Â°C)</label>
                                <div class="slider-container">
                                    <input type="range" id="testbed-ambient-slider" class="slider" min="15" max="35" step="1" value="24">
                                    <span id="testbed-ambient-value" class="value-display">24Â°C</span>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <label for="testbed-speedup-select">Simulation Speed</label>
                                <select id="testbed-speedup-select" class="control-select">
                                    <option value="1">1x</option>
                                    <option value="2">2x</option>
                                    <option value="4">4x</option>
                                    <option value="8" selected>8x</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Temperature Chart -->
                        <div id="testbed-temperature-chart" class="chart-container temperature"></div>
                        
                        <!-- Control Chart -->
                        <div id="testbed-control-chart" class="chart-container control"></div>
                        
                        <!-- Status Display -->
                        <div class="status-section">
                            <h3>Status</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                <div class="status-item">
                                    <div class="status-label">Bean Probe</div>
                                    <div id="testbed-bean-temp" class="status-value">25Â°C</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Bean Surface</div>
                                    <div id="testbed-env-temp" class="status-value">25Â°C</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Drum</div>
                                    <div id="testbed-roaster-temp" class="status-value">25Â°C</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Environment</div>
                                    <div id="testbed-air-temp" class="status-value">25Â°C</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Roast Time</div>
                                    <div id="testbed-roast-time" class="status-value">00:00</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Rate of Rise</div>
                                    <div id="testbed-rate-of-rise" class="status-value">0Â°C/min</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="testbed-empty" class="testbed-empty-state">
                        <div class="empty-icon">ðŸ§ª</div>
                        <h3>Digital Testbed</h3>
                        <p>Select your models and click "Load Models" to begin simulation</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload Roast View -->
        <div id="upload-view" class="view">
            <div class="upload-card">
                <h2>Upload New Roast</h2>
                
                <form id="upload-form">
                    <!-- File Upload -->
                    <div class="form-group">
                        <label for="roast-file">Roast File (.alog) *</label>
                        <input 
                            type="file" 
                            id="roast-file" 
                            accept=".alog"
                            required
                        >
                        <div class="form-hint">Select an .alog file from your roaster</div>
                    </div>
                    
                    <!-- Roaster -->
                    <div class="form-group">
                        <label for="roaster">Roaster</label>
                        <input 
                            type="text" 
                            id="roaster" 
                            placeholder="e.g., Kaleido M1, Aillio Bullet, etc."
                        >
                        <div class="form-hint">Optional: Specify which roaster was used</div>
                    </div>
                    
                    <!-- Origin and Variety -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="origin">Origin *</label>
                            <input 
                                type="text" 
                                id="origin" 
                                placeholder="e.g., Ethiopia"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="variety">Variety *</label>
                            <input 
                                type="text" 
                                id="variety" 
                                placeholder="e.g., Heirloom"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Roast Date -->
                    <div class="form-group">
                        <label for="roast-date">Roast Date *</label>
                        <input 
                            type="date" 
                            id="roast-date" 
                            required
                        >
                    </div>
                    
                    <!-- Process Method -->
                    <div class="form-group">
                        <label for="process">Process Method *</label>
                        <select id="process" required>
                            <option value="">Select process method...</option>
                            <option value="washed">Washed</option>
                            <option value="natural">Natural</option>
                            <option value="honey">Honey</option>
                            <option value="semi-washed">Semi-Washed</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Charge Mass and Final Mass -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charge-mass">Charge Mass (g) *</label>
                            <input 
                                type="number" 
                                id="charge-mass" 
                                placeholder="e.g., 150"
                                step="0.1"
                                min="0"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="final-mass">Final Mass (g) *</label>
                            <input 
                                type="number" 
                                id="final-mass" 
                                placeholder="e.g., 130"
                                step="0.1"
                                min="0"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Ambient Conditions -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ambient-temp">Ambient Temp (Â°C) *</label>
                            <input 
                                type="number" 
                                id="ambient-temp" 
                                placeholder="e.g., 24"
                                step="0.1"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="relative-humidity">Relative Humidity (%) *</label>
                            <input 
                                type="number" 
                                id="relative-humidity" 
                                placeholder="e.g., 60"
                                step="0.1"
                                min="0"
                                max="100"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" class="btn-primary" id="upload-btn">
                        Upload Roast
                    </button>
                </form>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Edit Roast Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Roast</h2>
                <button class="modal-close" id="edit-modal-close">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="edit-form">
                    <!-- Hidden field to store roast ID -->
                    <input type="hidden" id="edit-roast-id">
                    
                    <!-- Roaster -->
                    <div class="form-group">
                        <label for="edit-roaster">Roaster</label>
                        <input 
                            type="text" 
                            id="edit-roaster" 
                            placeholder="e.g., Kaleido M1, Aillio Bullet, etc."
                        >
                    </div>
                    
                    <!-- Origin and Variety -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-origin">Origin *</label>
                            <input 
                                type="text" 
                                id="edit-origin" 
                                placeholder="e.g., Ethiopia"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-variety">Variety *</label>
                            <input 
                                type="text" 
                                id="edit-variety" 
                                placeholder="e.g., Heirloom"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Roast Date -->
                    <div class="form-group">
                        <label for="edit-roast-date">Roast Date *</label>
                        <input 
                            type="date" 
                            id="edit-roast-date" 
                            required
                        >
                    </div>
                    
                    <!-- Process Method -->
                    <div class="form-group">
                        <label for="edit-process">Process Method *</label>
                        <select id="edit-process" required>
                            <option value="">Select process method...</option>
                            <option value="washed">Washed</option>
                            <option value="natural">Natural</option>
                            <option value="honey">Honey</option>
                            <option value="semi-washed">Semi-Washed</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Charge Mass and Final Mass -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-charge-mass">Charge Mass (g) *</label>
                            <input 
                                type="number" 
                                id="edit-charge-mass" 
                                placeholder="e.g., 150"
                                step="0.1"
                                min="0"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-final-mass">Final Mass (g) *</label>
                            <input 
                                type="number" 
                                id="edit-final-mass" 
                                placeholder="e.g., 130"
                                step="0.1"
                                min="0"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Ambient Conditions -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-ambient-temp">Ambient Temp (Â°C) *</label>
                            <input 
                                type="number" 
                                id="edit-ambient-temp" 
                                placeholder="e.g., 24"
                                step="0.1"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-relative-humidity">Relative Humidity (%) *</label>
                            <input 
                                type="number" 
                                id="edit-relative-humidity" 
                                placeholder="e.g., 60"
                                step="0.1"
                                min="0"
                                max="100"
                                required
                            >
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="edit-cancel-btn">Cancel</button>
                <button type="submit" form="edit-form" class="btn-primary" id="edit-save-btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Visualization Modal -->
    <div id="visualization-modal" class="modal-overlay">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="visualization-title">Roast Visualization</h2>
                <button class="modal-close" id="viz-modal-close">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Chart Container -->
                <div id="roast-chart" class="chart-container"></div>
                
                <!-- Loading State -->
                <div id="chart-loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>Loading roast data...</div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="viz-close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="./src/pages/dashboard/dashboard.ts"></script>
</body>
</html>
