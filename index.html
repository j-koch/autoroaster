<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Roaster Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin: 0 0 30px 0;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            min-width: 80px;
        }

        button:hover {
            background: #555;
        }

        button:active {
            background: #222;
        }

        button.active {
            background: #666;
        }

        .increment-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
        }

        .increment-control button {
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 4px 8px;
            min-width: 30px;
            font-size: 12px;
        }

        .increment-control button:hover {
            background: #f0f0f0;
        }

        .increment-control span {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
        }

        .status-item {
            text-align: center;
        }

        .status-item .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-item .value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .status {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Coffee Roaster</h1>

        <div class="controls">
            <!-- Roast Control Buttons -->
            <div class="control-group">
                <label>Roast Control</label>
                <div style="display: flex; gap: 8px;">
                    <button id="chargeBtn">Charge</button>
                    <button id="dropBtn">Drop</button>
                    <button id="resetBtn">Reset</button>
                </div>
            </div>

            <!-- Heat Control -->
            <div class="control-group">
                <label>Heat (%)</label>
                <div class="increment-control">
                    <button onclick="adjustControl('heat', -5)">-</button>
                    <span id="heatValue">0</span>
                    <button onclick="adjustControl('heat', 5)">+</button>
                </div>
            </div>

            <!-- Fan Control -->
            <div class="control-group">
                <label>Fan (%)</label>
                <div class="increment-control">
                    <button onclick="adjustControl('fan', -5)">-</button>
                    <span id="fanValue">0</span>
                    <button onclick="adjustControl('fan', 5)">+</button>
                </div>
            </div>

            <!-- Drum Control -->
            <div class="control-group">
                <label>Drum (%)</label>
                <div class="increment-control">
                    <button onclick="adjustControl('drum', -5)">-</button>
                    <span id="drumValue">0</span>
                    <button onclick="adjustControl('drum', 5)">+</button>
                </div>
            </div>
        </div>

        <!-- Single Chart Container -->
        <div class="chart-container">
            <div id="mainChart"></div>
        </div>

        <!-- Status Display -->
        <div class="status">
            <div class="status-item">
                <div class="label">Time</div>
                <div class="value" id="currentTime">0:00</div>
            </div>
            <div class="status-item">
                <div class="label">Bean Temp</div>
                <div class="value" id="currentBeanTemp">20°C</div>
            </div>
            <div class="status-item">
                <div class="label">Environment</div>
                <div class="value" id="currentEnvTemp">22°C</div>
            </div>
            <div class="status-item">
                <div class="label">Rate of Rise</div>
                <div class="value" id="rateOfRise">0°C/min</div>
            </div>
            <div class="status-item">
                <div class="label">Phase</div>
                <div class="value" id="currentPhase">Ready</div>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let roastData = {
            time: [],           // Time points in minutes since charge
            beanTemp: [],       // Measured bean temperature (°C)
            envTemp: [],        // Environment temperature (°C)
            rateOfRise: [],     // Rate of rise (°C/min)
            heatSetting: [],    // Heat control setting (%)
            fanSetting: [],     // Fan control setting (%)
            drumSetting: []     // Drum control setting (%)
        };

        let roastState = {
            isCharged: false,   // Whether beans have been charged
            isRunning: false,   // Whether roast is actively running
            startTime: null,    // Timestamp when roast was charged
            currentHeat: 0,     // Current heat setting (0-100%)
            currentFan: 0,      // Current fan setting (0-100%)
            currentDrum: 0      // Current drum setting (0-100%)
        };

        let updateTimer = null;

        // Initialize the main chart
        function initializeChart() {
            const layout = {
                title: '',
                xaxis: { 
                    title: 'Time (minutes)',
                    gridcolor: '#f0f0f0',
                    showgrid: true,
                    zeroline: false
                },
                yaxis: { 
                    title: 'Temperature (°C)',
                    side: 'left',
                    gridcolor: '#f0f0f0',
                    showgrid: true,
                    zeroline: false,
                    range: [0, 250]
                },
                yaxis2: {
                    title: 'Rate of Rise (°C/min) & Controls (%)',
                    side: 'right',
                    overlaying: 'y',
                    showgrid: false,
                    zeroline: false,
                    range: [0, 100]
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: { l: 60, r: 80, t: 30, b: 60 },
                showlegend: true,
                legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.8)' },
                font: { family: 'Segoe UI, sans-serif', size: 12, color: '#333' }
            };

            // Define all traces for the chart
            const traces = [
                // Temperature measurements (left y-axis)
                {
                    x: roastData.time,
                    y: roastData.beanTemp,
                    mode: 'lines+markers',
                    name: 'Bean Temperature',
                    line: { color: '#d32f2f', width: 3 },
                    marker: { size: 4, color: '#d32f2f' },
                    yaxis: 'y'
                },
                {
                    x: roastData.time,
                    y: roastData.envTemp,
                    mode: 'lines+markers',
                    name: 'Environment',
                    line: { color: '#ff9800', width: 2 },
                    marker: { size: 3, color: '#ff9800' },
                    yaxis: 'y'
                },
                // Rate of rise (right y-axis)
                {
                    x: roastData.time,
                    y: roastData.rateOfRise,
                    mode: 'lines',
                    name: 'Rate of Rise',
                    line: { color: '#2196f3', width: 2, dash: 'dot' },
                    yaxis: 'y2'
                },
                // Control settings (right y-axis)
                {
                    x: roastData.time,
                    y: roastData.heatSetting,
                    mode: 'lines',
                    name: 'Heat',
                    line: { color: '#f44336', width: 1 },
                    yaxis: 'y2'
                },
                {
                    x: roastData.time,
                    y: roastData.fanSetting,
                    mode: 'lines',
                    name: 'Fan',
                    line: { color: '#4caf50', width: 1 },
                    yaxis: 'y2'
                },
                {
                    x: roastData.time,
                    y: roastData.drumSetting,
                    mode: 'lines',
                    name: 'Drum',
                    line: { color: '#9c27b0', width: 1 },
                    yaxis: 'y2'
                }
            ];

            Plotly.newPlot('mainChart', traces, layout, { responsive: true });
        }

        // Adjust control settings (heat, fan, drum) in 5% increments
        function adjustControl(control, delta) {
            const currentValue = roastState[`current${control.charAt(0).toUpperCase() + control.slice(1)}`];
            const newValue = Math.max(0, Math.min(100, currentValue + delta));
            
            roastState[`current${control.charAt(0).toUpperCase() + control.slice(1)}`] = newValue;
            document.getElementById(`${control}Value`).textContent = newValue;
            
            console.log(`${control} adjusted to ${newValue}%`);
        }

        // Generate realistic roasting data point based on current settings and physics
        function generateDataPoint() {
            if (!roastState.isRunning) return;

            const currentTime = (Date.now() - roastState.startTime) / 60000; // Minutes since charge
            
            // Simulate bean temperature based on heat input and thermal dynamics
            const prevBeanTemp = roastData.beanTemp.length > 0 ? 
                roastData.beanTemp[roastData.beanTemp.length - 1] : 20;
            
            // Heat transfer rate depends on heat setting and temperature difference
            const ambientTemp = 22;
            const heatInput = roastState.currentHeat * 0.8; // Heat efficiency factor
            const fanCooling = roastState.currentFan * 0.3; // Fan cooling effect
            
            // Simple thermal model: dT/dt = heat_input - cooling - heat_loss
            const dt = 0.1; // 6-second intervals (0.1 minutes)
            const heatRate = heatInput * (1 - Math.exp(-currentTime / 5)); // Gradual heat-up
            const coolingRate = fanCooling + 0.5 * (prevBeanTemp - ambientTemp) / 100;
            
            const tempChange = (heatRate - coolingRate) * dt;
            const newBeanTemp = Math.max(ambientTemp, prevBeanTemp + tempChange + (Math.random() - 0.5) * 0.5);
            
            // Environment temperature is higher than bean temp
            const envTemp = newBeanTemp + 15 + roastState.currentHeat * 0.2 + (Math.random() - 0.5) * 2;
            
            // Calculate rate of rise (temperature change per minute)
            let rateOfRise = 0;
            if (roastData.beanTemp.length > 5) {
                const timeDiff = currentTime - roastData.time[roastData.time.length - 6];
                const tempDiff = newBeanTemp - roastData.beanTemp[roastData.beanTemp.length - 6];
                rateOfRise = timeDiff > 0 ? (tempDiff / timeDiff) : 0;
            }
            
            // Add data points
            roastData.time.push(currentTime);
            roastData.beanTemp.push(Math.round(newBeanTemp * 10) / 10);
            roastData.envTemp.push(Math.round(envTemp * 10) / 10);
            roastData.rateOfRise.push(Math.round(rateOfRise * 10) / 10);
            roastData.heatSetting.push(roastState.currentHeat);
            roastData.fanSetting.push(roastState.currentFan);
            roastData.drumSetting.push(roastState.currentDrum);
            
            // Limit data to last 1000 points for performance
            const maxPoints = 1000;
            if (roastData.time.length > maxPoints) {
                Object.keys(roastData).forEach(key => {
                    roastData[key] = roastData[key].slice(-maxPoints);
                });
            }
        }

        // Update the chart with new data
        function updateChart() {
            if (roastData.time.length === 0) return;
            
            Plotly.restyle('mainChart', {
                x: [roastData.time, roastData.time, roastData.time, roastData.time, roastData.time, roastData.time],
                y: [roastData.beanTemp, roastData.envTemp, roastData.rateOfRise, 
                    roastData.heatSetting, roastData.fanSetting, roastData.drumSetting]
            });
        }

        // Update status display
        function updateStatus() {
            if (roastData.time.length === 0) return;
            
            const lastIndex = roastData.time.length - 1;
            const currentTime = roastData.time[lastIndex];
            const currentBeanTemp = roastData.beanTemp[lastIndex];
            const currentEnvTemp = roastData.envTemp[lastIndex];
            const currentROR = roastData.rateOfRise[lastIndex];
            
            // Update time display
            const minutes = Math.floor(currentTime);
            const seconds = Math.floor((currentTime % 1) * 60);
            document.getElementById('currentTime').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update temperature displays
            document.getElementById('currentBeanTemp').textContent = `${currentBeanTemp}°C`;
            document.getElementById('currentEnvTemp').textContent = `${currentEnvTemp}°C`;
            document.getElementById('rateOfRise').textContent = `${currentROR}°C/min`;
            
            // Update roast phase
            let phase = 'Drying';
            if (currentTime > 3 && currentBeanTemp > 100) phase = 'Maillard';
            if (currentTime > 8 && currentBeanTemp > 150) phase = 'Development';
            if (currentBeanTemp > 200) phase = 'Finish';
            
            document.getElementById('currentPhase').textContent = phase;
        }

        // Main update loop
        function roastLoop() {
            if (!roastState.isRunning) return;
            
            generateDataPoint();
            updateChart();
            updateStatus();
            
            // Schedule next update (every 100ms for smooth animation)
            updateTimer = setTimeout(roastLoop, 100);
        }

        // Button event handlers
        function chargeRoast() {
            if (roastState.isCharged) return;
            
            roastState.isCharged = true;
            roastState.isRunning = true;
            roastState.startTime = Date.now();
            
            document.getElementById('chargeBtn').classList.add('active');
            document.getElementById('chargeBtn').textContent = 'Running';
            
            console.log('Roast charged - starting data collection');
            roastLoop();
        }

        function dropRoast() {
            if (!roastState.isCharged) return;
            
            roastState.isRunning = false;
            
            document.getElementById('dropBtn').classList.add('active');
            document.getElementById('dropBtn').textContent = 'Dropped';
            
            if (updateTimer) {
                clearTimeout(updateTimer);
                updateTimer = null;
            }
            
            console.log('Beans dropped - roast complete');
        }

        function resetRoast() {
            // Stop any running processes
            roastState.isCharged = false;
            roastState.isRunning = false;
            roastState.startTime = null;
            
            if (updateTimer) {
                clearTimeout(updateTimer);
                updateTimer = null;
            }
            
            // Reset control settings
            roastState.currentHeat = 0;
            roastState.currentFan = 0;
            roastState.currentDrum = 0;
            
            document.getElementById('heatValue').textContent = '0';
            document.getElementById('fanValue').textContent = '0';
            document.getElementById('drumValue').textContent = '0';
            
            // Reset button states
            document.getElementById('chargeBtn').classList.remove('active');
            document.getElementById('chargeBtn').textContent = 'Charge';
            document.getElementById('dropBtn').classList.remove('active');
            document.getElementById('dropBtn').textContent = 'Drop';
            
            // Clear all data
            Object.keys(roastData).forEach(key => {
                roastData[key] = [];
            });
            
            // Reset chart
            initializeChart();
            
            // Reset status
            document.getElementById('currentTime').textContent = '0:00';
            document.getElementById('currentBeanTemp').textContent = '20°C';
            document.getElementById('currentEnvTemp').textContent = '22°C';
            document.getElementById('rateOfRise').textContent = '0°C/min';
            document.getElementById('currentPhase').textContent = 'Ready';
            
            console.log('System reset');
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize chart
            initializeChart();
            
            // Set up button event listeners
            document.getElementById('chargeBtn').addEventListener('click', chargeRoast);
            document.getElementById('dropBtn').addEventListener('click', dropRoast);
            document.getElementById('resetBtn').addEventListener('click', resetRoast);
            
            console.log('Coffee Roaster Dashboard initialized');
        });
    </script>
</body>
</html>